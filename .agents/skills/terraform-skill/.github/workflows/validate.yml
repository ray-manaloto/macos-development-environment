name: Validate Skill

on:
  pull_request:
    paths:
      - 'SKILL.md'
      - 'references/**/*.md'
      - '.claude-plugin/**'
  push:
    branches: [master, main]
    paths:
      - 'SKILL.md'
      - 'references/**/*.md'
      - '.claude-plugin/**'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Skill Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install pyyaml

      - name: Check SKILL.md Frontmatter
        run: |
          python3 << 'EOF'
          import yaml
          import sys
          import re

          print("üîç Validating SKILL.md frontmatter...")

          with open('SKILL.md', 'r') as f:
              content = f.read()

          if not content.startswith('---'):
              print("‚ùå ERROR: No frontmatter found")
              sys.exit(1)

          parts = content.split('---', 2)
          if len(parts) < 3:
              print("‚ùå ERROR: Invalid frontmatter format")
              sys.exit(1)

          frontmatter = yaml.safe_load(parts[1])

          # Check required fields (but allow additional optional fields)
          required = {'name', 'description'}
          missing = required - set(frontmatter.keys())

          if missing:
              print(f"‚ùå ERROR: Missing required fields: {missing}")
              sys.exit(1)

          # Log optional fields if present (informational only)
          optional_fields = set(frontmatter.keys()) - required
          if optional_fields:
              print(f"üìã Optional fields present: {optional_fields}")

              if 'license' in frontmatter:
                  print(f"   - license: {frontmatter['license']}")

              if 'metadata' in frontmatter:
                  metadata = frontmatter['metadata']
                  if isinstance(metadata, dict):
                      if 'version' in metadata:
                          print(f"   - metadata.version: {metadata['version']}")
                      if 'author' in metadata:
                          print(f"   - metadata.author: {metadata['author']}")

          name = frontmatter['name']
          if not re.match(r'^[a-zA-Z0-9-]+$', name):
              print(f"‚ùå ERROR: Invalid name: {name}")
              sys.exit(1)

          desc_len = len(frontmatter['description'])
          if desc_len > 1024:
              print(f"‚ùå ERROR: Description too long: {desc_len} chars")
              sys.exit(1)

          print(f"‚úÖ Frontmatter valid ({desc_len} chars)")
          EOF

      - name: Check File Size
        run: |
          LINES=$(wc -l < SKILL.md)
          WORDS=$(wc -w < SKILL.md)
          echo "üìä SKILL.md: $LINES lines, $WORDS words"
          if [ $LINES -gt 500 ]; then
            echo "‚ö†Ô∏è  WARNING: $LINES lines (guideline: <500)"
          else
            echo "‚úÖ Size OK"
          fi

      - name: Validate marketplace.json
        run: |
          python3 << 'EOF'
          import json
          import sys
          import re

          print("üîç Validating marketplace.json...")

          with open('.claude-plugin/marketplace.json', 'r') as f:
              marketplace = json.load(f)

          # Validate marketplace-level fields
          required_marketplace = ['name', 'owner', 'version', 'plugins']
          missing = [f for f in required_marketplace if f not in marketplace]

          if missing:
              print(f"‚ùå ERROR: Missing marketplace fields: {missing}")
              sys.exit(1)

          # Validate owner structure
          if 'name' not in marketplace['owner']:
              print("‚ùå ERROR: owner must have 'name'")
              sys.exit(1)

          # Validate version format
          version = marketplace['version']
          if not re.match(r'^\d+\.\d+\.\d+$', version):
              print(f"‚ùå ERROR: Invalid marketplace version: {version}")
              sys.exit(1)

          # Validate plugins array
          if not isinstance(marketplace['plugins'], list) or len(marketplace['plugins']) == 0:
              print("‚ùå ERROR: 'plugins' must be a non-empty array")
              sys.exit(1)

          # Validate each plugin
          for idx, plugin in enumerate(marketplace['plugins']):
              required_plugin = ['name', 'description', 'source']
              missing = [f for f in required_plugin if f not in plugin]

              if missing:
                  print(f"‚ùå ERROR: Plugin {idx} missing fields: {missing}")
                  sys.exit(1)

          print(f"‚úÖ marketplace.json valid (v{version}, {len(marketplace['plugins'])} plugin(s))")
          EOF

      - name: Check for Broken Links
        run: |
          echo "üîç Checking internal links..."
          if grep -oP '\[.*?\]\(references/.*?\.md.*?\)' SKILL.md references/*.md 2>/dev/null | \
             sed 's/.*(//' | sed 's/).*//' | sed 's/#.*//' | \
             while read -r link; do
               if [ ! -f "$link" ]; then
                 echo "‚ùå ERROR: Broken link: $link"
                 exit 1
               fi
             done
          then
            echo "‚úÖ No broken links"
          fi

      - name: Lint Markdown
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            SKILL.md
            references/**/*.md
            README.md
            CONTRIBUTING.md
        continue-on-error: true

      - name: Summary
        if: success()
        run: |
          echo "## ‚úÖ Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "All skill validation checks passed." >> $GITHUB_STEP_SUMMARY
